# Docker Compose for local development with DynamoDB Local
# Usage: docker-compose up
# Frontend: http://localhost:5173
# Dev API: http://localhost:3001 
# DynamoDB Admin UI: Use AWS CLI or NoSQL Workbench pointing to http://localhost:8000

services:
  # Frontend React app (Vite dev server with HMR)
  app:
    build:
      context: .
      target: dev
      dockerfile: Dockerfile
    container_name: financeflow-app
    ports:
      - "5173:5173"
    volumes:
      # Bind mount source code for HMR
      - ./src:/app/src
      - ./public:/app/public
      - ./index.html:/app/index.html
      - ./vite.config.ts:/app/vite.config.ts
      - ./tsconfig.json:/app/tsconfig.json
      - ./tsconfig.app.json:/app/tsconfig.app.json
      - ./tsconfig.node.json:/app/tsconfig.node.json
      - ./postcss.config.js:/app/postcss.config.js
      - ./tailwind.config.js:/app/tailwind.config.js
      - ./.env.docker:/app/.env
    environment:
      # Dev auth but with DynamoDB Local
      - VITE_DEV_ONLY_AUTH=true
      - VITE_USE_DYNAMODB=true
      - VITE_ENVIRONMENT=docker-local
      - VITE_AWS_REGION=eu-north-1
      - VITE_API_GATEWAY_URL=http://localhost:3001
    depends_on:
      - dev-api
      - dynamodb-local
    networks:
      - financeflow-network

  # Development API server (Express + OpenAI)
  dev-api:
    build:
      context: ./dev-server
      dockerfile: Dockerfile
    container_name: financeflow-dev-api
    ports:
      - "3001:3001"
    volumes:
      # Bind mount for dev-server code changes
      - ./dev-server:/app
      - /app/node_modules  # Anonymous volume to prevent overwriting
    environment:
      - NODE_ENV=development
      - PORT=3001
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - AWS_ACCESS_KEY_ID=fakeAccessKeyId
      - AWS_SECRET_ACCESS_KEY=fakeSecretAccessKey
      - AWS_REGION=eu-north-1
      # OPENAI_API_KEY loaded from .env file
    env_file:
      - ./dev-server/.env
    depends_on:
      - dynamodb-local
    networks:
      - financeflow-network

  # DynamoDB Local for development (official configuration)
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: dynamodb-local
    hostname: dynamodb-local
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath ./data"
    volumes:
      - "./docker/dynamodb:/home/dynamodblocal/data"
    working_dir: /home/dynamodblocal
    networks:
      - financeflow-network

networks:
  financeflow-network:
    driver: bridge
